---
title: "LPI-sensitivity_CAD-paper"
author: "sarah ravoth"
date: "2024-07-05"
output: html_document
---

## load packages
```{r, include = FALSE}
library(tidyverse)
library(dplyr)
library(purrr)
library(ggplot2)
library(readr)
library(rlpi)
library(here)
```

## load datafiles 
```{r, include=FALSE}

# set working directory throughout all code chunks as homepage
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# load data
# load in canadian LPI data
cad <- read.csv(here("00_rawdata", "Canada_data_MOCKDATA.csv"), header=TRUE)

# load population-level lambdas
pop_lambdas <- read.csv(here("02_outdata", "Group3_Confidence-Intervals", "CAD_20240607_unweighted_pops_PopLambda.txt"), header=TRUE)

# load species-level lambdas
spp_lambdas <- read.csv(here("02_outdata", "Group3_Confidence-Intervals", "CAD_20240607_unweighted_pops_lambda.csv"), header=TRUE) 

# load LPIMain output data
lpi_out <- read.csv(here("02_outdata", "Group3_Confidence-Intervals", "LPI-sensitivity_conf-int_CAD-unweighted-year-CIs.csv"), header=TRUE) 

# load df with information on zeros
cad_zeros <- read.csv(here("02_outdata", "Group3_Confidence-Intervals", "CAD_data_zeros.csv"), header=TRUE) 


# set source of bootstrap_by_rows() function
source(here("01_scripts","Group3_Confidence-Intervals","LPI-sensitivity_Group3_function_bootstrap_rows.R"))
```

 
## table of contents 
section 0: tidying

section 1: code

-   1.1: confidence intervals
  *   1.1.1: calculate confidence intervals via 3 approaches (bootstrap by populations, species, and years)
  *   1.1.2: boxplot of confidence interval range for 3 approaches
-   1.2: weighting trend comparison
-   1.3: baseline
  *   1.3.1: run CAD LPI with various baseline years & measure average rate of change
  *   1.3.2: boxplot of average rate of change across baselines
-   1.4: log-linear vs linear modelling

section 2: manuscript figures (primary & supplementary)

## section 0: tidying
```{r}
# join binomial spp name to popn ID for pop-level lambdas
cad.names <- cad %>% 
  select(ID, Binomial) %>% 
  rename(population_id = ID)

# add spp name to popn lambda file
pop_lambdas <- left_join(pop_lambdas, cad.names)

# change all 0 to NULL
cad[cad==0] <- "NULL" # set 0 to NULL
```

## section 1: code

### 1.1: confidence intervals
#### 1.1.1: calculate confidence intervals via 3 approaches

**important note: all bootstrapping iterations are currently at 100 to run faster, but needs to be changed to 10,000 runs for future analyses.  

the purpose of this script is to run the 3 methods to bootstrap confidence intervals on the canadian LPI subset. bootstrapping occurs on unweighted data by population, species, and within years. 

by population
```{r, message=FALSE, warning=FALSE}
# LPIs are bootstrapped *with replacement* for each species in the dataset

# run the function to resample with replacement 100 times
boot_pop <- bootstrap_by_rows(pop_lambdas, species_column_name="Binomial" , start_col_name="X1970",end_col_name="X2020", iter=TRUE , N=100)
boot_pop_CI <- as.data.frame(boot_pop$interval_data) # save CI intervals in a separate object
boot_pop_CI$year <- as.numeric(boot_pop_CI$year) # change year from character to numeric

# save data to csv
# write.csv(boot_pop_CI, file.path("02_outdata","Group3_Confidence-Intervals","LPI-sensitivity_conf-int_CAD-unweighted-pop-CIs.csv"))

```

```{r, echo=FALSE}
# plot
ggplot() +
  geom_ribbon(data=boot_pop_CI, aes(x=year, y=mean_lpi, ymax = Upper_CI, ymin = Lower_CI), alpha=0.6, fill="light blue") +
  geom_line(data=lpi_out, aes(x=year, y=LPI_final), size=1, col="black") +
  ylim(0, 2) + 
  xlim(1970, 2018) + 
  labs(x="Year", y="LPI Index") + 
  theme_bw()
```

by species
```{r, message=FALSE, warning=FALSE}
# LPIs are bootstrapped *with replacement* for each species in the dataset

# run the function to resample with replacement 100 times
boot_spp <- bootstrap_by_rows(spp_lambdas, species_column_name="Binomial" , start_col_name="X1970",end_col_name="X2020", iter=TRUE , N=100)
boot_spp_CI <- as.data.frame(boot_spp$interval_data) # save CI intervals in a separate object
boot_spp_CI$year <- as.numeric(boot_spp_CI$year ) # change year from character to numeric

# save the CI data bootstrapped by species
#write.csv(boot_spp_CI,file.path("02_outdata","Group3_Confidence-Intervals","LPI-sensitivity_conf-int_CAD-unweighted-species-CIs.csv"))
```

```{r, echo=FALSE}
# plot
ggplot() +
  geom_ribbon(data=boot_spp_CI, aes(x=year, y=mean_lpi, ymax = Upper_CI, ymin = Lower_CI), alpha=0.6, fill="purple") +
  geom_line(data=lpi_out, aes(x=year, y=LPI_final), size=1, col="black") +
  ylim(0, 2) + 
  xlim(1970, 2018) + 
  labs(x="Year", y="LPI Index") + 
  theme_bw()
```

by year
```{r, echo=FALSE}
ggplot(lpi_out) +
  geom_ribbon(aes(x=year, y=LPI_final, ymax = CI_high, ymin = CI_low), alpha=0.6, fill="salmon") +
  geom_line(aes(x=year, y=LPI_final), size=1, col="black") +
  ylim(0, 2) + 
  xlim(1970, 2018) + 
  labs(x="Year", y="LPI Index") + 
  theme_bw()
```

compare all 3 types
```{r, echo=FALSE}
cad_boot_CIs <- ggplot() +
    geom_ribbon(data=boot_spp_CI, aes(x=year, y=mean_lpi, ymax = Upper_CI, ymin = Lower_CI), alpha=0.8, fill="purple") + # spp bootstrap
  geom_ribbon(data=boot_pop_CI, aes(x=year, y=mean_lpi, ymax = Upper_CI, ymin = Lower_CI), alpha=0.6, fill="light blue") + # popn bootstrap
  geom_ribbon(data=lpi_out, aes(x=year, y=LPI_final, ymax = CI_high, ymin = CI_low), alpha=0.9, fill="salmon") + # year bootstrap
  geom_line(data=lpi_out, aes(x=year, y=LPI_final), size=1, col="black") +
  ylim(0, 2) + 
  xlim(1970, 2018) + 
  labs(x="Year", y="LPI Index") + 
  theme_bw() 

cad_boot_CIs

# save plot
# ggsave(here("03_figs", "Group 3", "3methods-canada-LPI.png"), cad_boot_CIs)
```
lpi_temp/PopProcessed_LM.txt


#### 1.1.2: boxplot of confidence interval range for 3 approaches
```{r}
# modified from maria's script (file = LPI-sensitivity_Group3_compare-intervals.R) 

data_folder_path <- "./02_outdata/Group3_Confidence-Intervals"

# create method labels
bootstrap_method_label <- c("year bootstrap",
                            "species bootstrap",
                            "population bootstrap")#,
# "GAM_data")

# assign column labels
col_labs <- list(c("...1","CI_low","CI_high"),
                 c("year","Lower_CI","Upper_CI"),
                 c("year","Lower_CI","Upper_CI"))

# assign paths for each method file
bootstrap_method_output_path <- c(file.path(data_folder_path,"LPI-sensitivity_conf-int_CAD-unweighted-year-CIs.csv"),
                                  file.path(data_folder_path,"LPI-sensitivity_conf-int_CAD-unweighted-species-CIs.csv"),
                                  file.path(data_folder_path,"LPI-sensitivity_conf-int_CAD-unweighted-pop-CIs.csv"))

# read bootstrap data and assign method name
l_bootstrap_data <- map2(bootstrap_method_output_path, col_labs, 
                         ~read_csv(.x) |> 
                           select(contains(.y)) |> 
                           setNames(c("Year","Lower_CI","Upper_CI"))) |> 
  setNames(bootstrap_method_label)

# convert to dataframe
df_bootstrap_data <- l_bootstrap_data |> bind_rows(.id="method")
df_bootstrap_data_range <- df_bootstrap_data |> mutate(range=Upper_CI-Lower_CI)

# create boxplot
img_bootstrap_methods_boxplot <- ggplot(df_bootstrap_data_range, aes(x=method,y=range))+
  geom_boxplot() + theme_classic() + ylab("Confidence Interval Range") + xlab("Bootstrap Method"); img_bootstrap_methods_boxplot

# to save file 
# ggsave("./03_figs/LPI-sensitivity_Group3_CAD_bootstrap_methods_boxplot.png",img_bootstrap_methods_boxplot)

```



### 1.2: weighting trend comparison
### 1.3: baseline
### 1.4: log-linear vs linear modelling

## section 2: manuscript figures (primary & supplementary)
```{r, echo=FALSE}
# reload cad data (previous tidying made changes that mess up this plot)
cad <- read.csv(here("00_rawdata", "Canada_data_MOCKDATA.csv"), header=TRUE)

# some tidying
plot_dat <- cad %>%
  left_join(., cad_zeros %>% select(ID, duration, first_value, last_value), by = "ID") %>%
  #mutate_at(c("T_realm", "M_realm", "FW_realm"), ~ifelse(. == "NULL", NA, .)) %>% # Merge all the realm names together, not in 3 cols
  #mutate(realm = coalesce(T_realm, M_realm, FW_realm)) %>%
  pivot_longer(X1950:X2020, names_to = "Year") %>%
  mutate(Year = as.numeric(str_remove(Year, "X")), 
         first_value = as.numeric(first_value),
         last_value = as.numeric(last_value), 
         Taxonomic_group = case_when(Taxonomic_group=="Mammalia" ~ "Mammals",
                                     Taxonomic_group=="Reptilia" ~ "Herps",
                                     TRUE ~ Taxonomic_group)) %>% 
  filter(!(value == "NULL")) %>%
  mutate(value_label = ifelse(value == 0, "Zero", "Non Zero")) %>%
  #arrange(duration) %>%
  arrange(desc(last_value)) %>% 
  mutate(plot_row_id = row_number())

# plot 
plot_dat %>% 
  ggplot(aes(x = Year, y = plot_row_id, color = value_label)) +
  geom_segment(aes(x = first_value, xend = last_value, y = plot_row_id, yend = plot_row_id),
               size = 0.1, col = "lightgrey",inherit.aes = FALSE) +
  geom_point(data=subset(plot_dat,value_label=="Non Zero"), size = 0.2) + # plot non-zero pts behind zero pts
  geom_point(data=subset(plot_dat,value_label=="Zero"), size = 0.2) + # make zero pts clearer by plotting in front
  scale_color_manual(values = c("darkgray", "red"), name="") +
  scale_x_continuous(breaks=seq(1950,2020,20)) + 
  scale_y_continuous(breaks=seq(0,60000,20000)) +
  facet_grid(System~Taxonomic_group)+
  theme_bw() +
  xlab("Year") +
  ylab("Population ID (ordered by time series end year)") +
  theme(strip.text = element_text(face="bold", size=12), 
        text = element_text(size=12), 
        legend.text = element_text(size=12)) + 
  guides(colour = guide_legend(override.aes = list(size=2)))
```









